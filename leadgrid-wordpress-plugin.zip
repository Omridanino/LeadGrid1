
<?php
/**
 * Plugin Name: LeadGrid - יצירת דפי נחיתה מקצועיים
 * Plugin URI: https://leadgrid.co.il
 * Description: פלאגין מתקדם ליצירה ועריכה של דפי נחיתה מקצועיים עם ממשק עריכה מלא ופרסום אוטומטי
 * Version: 2.1.0
 * Author: LeadGrid Team
 * Author URI: https://leadgrid.co.il
 * Text Domain: leadgrid
 * Domain Path: /languages
 * Requires at least: 5.0
 * Tested up to: 6.4
 * Requires PHP: 7.4
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * 
 * Network: false
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Define plugin constants
define('LEADGRID_VERSION', '2.1.0');
define('LEADGRID_PLUGIN_URL', plugin_dir_url(__FILE__));
define('LEADGRID_PLUGIN_PATH', plugin_dir_path(__FILE__));
define('LEADGRID_PLUGIN_BASENAME', plugin_basename(__FILE__));

/**
 * Main LeadGrid Plugin Class
 */
class LeadGridPlugin {
    
    /**
     * Instance of this class
     */
    private static $instance = null;
    
    /**
     * Get instance
     */
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * Constructor
     */
    public function __construct() {
        add_action('init', array($this, 'init'));
        add_action('admin_menu', array($this, 'add_admin_menu'));
        add_action('wp_enqueue_scripts', array($this, 'enqueue_frontend_scripts'));
        add_action('admin_enqueue_scripts', array($this, 'enqueue_admin_scripts'));
        add_action('wp_ajax_leadgrid_save_page', array($this, 'ajax_save_page'));
        add_action('wp_ajax_leadgrid_get_pages', array($this, 'ajax_get_pages'));
        add_action('wp_ajax_leadgrid_delete_page', array($this, 'ajax_delete_page'));
        add_action('wp_ajax_leadgrid_duplicate_page', array($this, 'ajax_duplicate_page'));
        add_action('template_redirect', array($this, 'handle_leadgrid_page_display'));
        add_shortcode('leadgrid_page', array($this, 'leadgrid_page_shortcode'));
        
        // Activation/Deactivation hooks
        register_activation_hook(__FILE__, array($this, 'activate'));
        register_deactivation_hook(__FILE__, array($this, 'deactivate'));
    }
    
    /**
     * Initialize plugin
     */
    public function init() {
        load_plugin_textdomain('leadgrid', false, dirname(LEADGRID_PLUGIN_BASENAME) . '/languages');
        $this->create_database_tables();
    }
    
    /**
     * Plugin activation
     */
    public function activate() {
        $this->create_database_tables();
        flush_rewrite_rules();
    }
    
    /**
     * Plugin deactivation
     */
    public function deactivate() {
        flush_rewrite_rules();
    }
    
    /**
     * Create database tables
     */
    private function create_database_tables() {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        
        $charset_collate = $wpdb->get_charset_collate();
        
        $sql = "CREATE TABLE $table_name (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            title varchar(255) NOT NULL,
            slug varchar(255) NOT NULL,
            content longtext NOT NULL,
            template_data longtext,
            status varchar(20) DEFAULT 'published',
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            author_id bigint(20) DEFAULT 1,
            meta_title varchar(255),
            meta_description text,
            custom_css longtext,
            custom_js longtext,
            PRIMARY KEY (id),
            UNIQUE KEY slug (slug),
            KEY status (status),
            KEY author_id (author_id)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
        
        // Update version
        update_option('leadgrid_db_version', LEADGRID_VERSION);
    }
    
    /**
     * Add admin menu
     */
    public function add_admin_menu() {
        add_menu_page(
            __('LeadGrid - דפי נחיתה', 'leadgrid'),
            __('LeadGrid', 'leadgrid'),
            'manage_options',
            'leadgrid',
            array($this, 'admin_page'),
            'data:image/svg+xml;base64,' . base64_encode('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>'),
            30
        );
        
        add_submenu_page(
            'leadgrid',
            __('כל הדפים', 'leadgrid'),
            __('כל הדפים', 'leadgrid'),
            'manage_options',
            'leadgrid',
            array($this, 'admin_page')
        );
        
        add_submenu_page(
            'leadgrid',
            __('דף חדש', 'leadgrid'),
            __('דף חדש', 'leadgrid'),
            'manage_options',
            'leadgrid-new',
            array($this, 'new_page_admin')
        );
        
        add_submenu_page(
            'leadgrid',
            __('הגדרות', 'leadgrid'),
            __('הגדרות', 'leadgrid'),
            'manage_options',
            'leadgrid-settings',
            array($this, 'settings_page')
        );
    }
    
    /**
     * Enqueue admin scripts
     */
    public function enqueue_admin_scripts($hook) {
        if (strpos($hook, 'leadgrid') === false) {
            return;
        }
        
        wp_enqueue_script('leadgrid-admin', LEADGRID_PLUGIN_URL . 'assets/admin.js', array('jquery'), LEADGRID_VERSION, true);
        wp_enqueue_style('leadgrid-admin', LEADGRID_PLUGIN_URL . 'assets/admin.css', array(), LEADGRID_VERSION);
        
        wp_localize_script('leadgrid-admin', 'leadgrid_ajax', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('leadgrid_nonce'),
            'strings' => array(
                'confirm_delete' => __('האם אתה בטוח שברצונך למחוק דף זה?', 'leadgrid'),
                'saving' => __('שומר...', 'leadgrid'),
                'saved' => __('נשמר בהצלחה!', 'leadgrid'),
                'error' => __('אירעה שגיאה', 'leadgrid'),
            )
        ));
    }
    
    /**
     * Enqueue frontend scripts
     */
    public function enqueue_frontend_scripts() {
        if ($this->is_leadgrid_page()) {
            wp_enqueue_style('leadgrid-frontend', LEADGRID_PLUGIN_URL . 'assets/frontend.css', array(), LEADGRID_VERSION);
            wp_enqueue_script('leadgrid-frontend', LEADGRID_PLUGIN_URL . 'assets/frontend.js', array('jquery'), LEADGRID_VERSION, true);
        }
    }
    
    /**
     * Check if current page is LeadGrid page
     */
    private function is_leadgrid_page() {
        global $wp_query;
        return isset($wp_query->query_vars['leadgrid_page']);
    }
    
    /**
     * Main admin page
     */
    public function admin_page() {
        ?>
        <div class="wrap leadgrid-admin" dir="rtl">
            <h1 class="wp-heading-inline">
                <img src="<?php echo LEADGRID_PLUGIN_URL . 'assets/logo.png'; ?>" alt="LeadGrid" style="height: 32px; vertical-align: middle; margin-left: 10px;">
                <?php _e('LeadGrid - דפי נחיתה מקצועיים', 'leadgrid'); ?>
            </h1>
            
            <a href="<?php echo admin_url('admin.php?page=leadgrid-new'); ?>" class="page-title-action">
                <?php _e('הוסף דף חדש', 'leadgrid'); ?>
            </a>
            
            <hr class="wp-header-end">
            
            <div class="leadgrid-dashboard">
                <div class="leadgrid-stats">
                    <div class="stat-box">
                        <h3><?php echo $this->get_pages_count(); ?></h3>
                        <p><?php _e('דפים פעילים', 'leadgrid'); ?></p>
                    </div>
                    <div class="stat-box">
                        <h3><?php echo $this->get_views_count(); ?></h3>
                        <p><?php _e('צפיות החודש', 'leadgrid'); ?></p>
                    </div>
                    <div class="stat-box">
                        <h3>99.9%</h3>
                        <p><?php _e('זמינות', 'leadgrid'); ?></p>
                    </div>
                </div>
                
                <div class="leadgrid-pages-list">
                    <h2><?php _e('הדפים שלך', 'leadgrid'); ?></h2>
                    
                    <div class="tablenav top">
                        <div class="alignleft actions">
                            <select id="bulk-action-selector-top">
                                <option value=""><?php _e('פעולות נפוצות', 'leadgrid'); ?></option>
                                <option value="duplicate"><?php _e('שכפל', 'leadgrid'); ?></option>
                                <option value="delete"><?php _e('מחק', 'leadgrid'); ?></option>
                            </select>
                            <input type="submit" class="button action" value="<?php _e('החל', 'leadgrid'); ?>">
                        </div>
                        
                        <div class="alignright actions">
                            <input type="search" id="leadgrid-search" placeholder="<?php _e('חפש דפים...', 'leadgrid'); ?>">
                        </div>
                    </div>
                    
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <td class="manage-column column-cb check-column">
                                    <input type="checkbox" id="cb-select-all">
                                </td>
                                <th class="manage-column column-title"><?php _e('כותרת', 'leadgrid'); ?></th>
                                <th class="manage-column column-slug"><?php _e('קישור', 'leadgrid'); ?></th>
                                <th class="manage-column column-status"><?php _e('סטטוס', 'leadgrid'); ?></th>
                                <th class="manage-column column-date"><?php _e('תאריך יצירה', 'leadgrid'); ?></th>
                                <th class="manage-column column-actions"><?php _e('פעולות', 'leadgrid'); ?></th>
                            </tr>
                        </thead>
                        <tbody id="leadgrid-pages-tbody">
                            <?php $this->render_pages_table(); ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <style>
        .leadgrid-admin {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .leadgrid-dashboard {
            margin-top: 20px;
        }
        
        .leadgrid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-box h3 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: bold;
        }
        
        .stat-box p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .leadgrid-pages-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .leadgrid-pages-list h2 {
            background: #f8f9fa;
            padding: 20px;
            margin: 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .page-actions {
            display: flex;
            gap: 8px;
        }
        
        .page-actions .button {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .status-published {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-draft {
            color: #ffc107;
            font-weight: bold;
        }
        
        .page-url {
            color: #007cba;
            text-decoration: none;
            font-family: monospace;
        }
        
        .page-url:hover {
            text-decoration: underline;
        }
        </style>
        <?php
    }
    
    /**
     * New page admin
     */
    public function new_page_admin() {
        ?>
        <div class="wrap leadgrid-editor" dir="rtl">
            <h1><?php _e('יצירת דף נחיתה חדש', 'leadgrid'); ?></h1>
            
            <div id="leadgrid-app">
                <div class="leadgrid-editor-container">
                    <!-- Loading state -->
                    <div id="leadgrid-loading" class="leadgrid-loading">
                        <div class="spinner"></div>
                        <p><?php _e('טוען את עורך הדפים...', 'leadgrid'); ?></p>
                    </div>
                    
                    <!-- Editor will be loaded here -->
                    <div id="leadgrid-editor-root"></div>
                </div>
            </div>
        </div>
        
        <style>
        .leadgrid-editor {
            margin: 0;
            padding: 0;
        }
        
        .leadgrid-editor-container {
            position: fixed;
            top: 32px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 9999;
        }
        
        .leadgrid-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #leadgrid-editor-root {
            width: 100%;
            height: 100vh;
            background: #000;
        }
        </style>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the full-screen editor
            setTimeout(function() {
                document.getElementById('leadgrid-loading').style.display = 'none';
                initializeLeadGridEditor();
            }, 1500);
        });
        
        function initializeLeadGridEditor() {
            const editorRoot = document.getElementById('leadgrid-editor-root');
            
            // Create iframe with the LeadGrid editor
            const iframe = document.createElement('iframe');
            iframe.src = 'https://leadgrid.lovable.app/?wp_mode=true&wp_url=' + encodeURIComponent(window.location.origin);
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.background = '#000';
            
            editorRoot.appendChild(iframe);
            
            // Listen for messages from the editor
            window.addEventListener('message', function(event) {
                if (event.origin !== 'https://leadgrid.lovable.app') return;
                
                if (event.data.type === 'leadgrid_save_page') {
                    savePageToWordPress(event.data.pageData);
                } else if (event.data.type === 'leadgrid_close_editor') {
                    window.location.href = '<?php echo admin_url("admin.php?page=leadgrid"); ?>';
                }
            });
        }
        
        function savePageToWordPress(pageData) {
            const formData = new FormData();
            formData.append('action', 'leadgrid_save_page');
            formData.append('nonce', '<?php echo wp_create_nonce("leadgrid_nonce"); ?>');
            formData.append('page_data', JSON.stringify(pageData));
            
            fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message and redirect
                    alert('הדף נשמר בהצלחה!');
                    window.location.href = '<?php echo admin_url("admin.php?page=leadgrid"); ?>';
                } else {
                    alert('שגיאה בשמירת הדף: ' + data.data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בשמירת הדף');
            });
        }
        </script>
        <?php
    }
    
    /**
     * Settings page
     */
    public function settings_page() {
        if (isset($_POST['submit'])) {
            $this->save_settings();
        }
        
        $settings = get_option('leadgrid_settings', array());
        ?>
        <div class="wrap" dir="rtl">
            <h1><?php _e('הגדרות LeadGrid', 'leadgrid'); ?></h1>
            
            <form method="post" action="">
                <?php wp_nonce_field('leadgrid_settings'); ?>
                
                <table class="form-table" role="presentation">
                    <tbody>
                        <tr>
                            <th scope="row">
                                <label for="google_analytics"><?php _e('Google Analytics ID', 'leadgrid'); ?></label>
                            </th>
                            <td>
                                <input type="text" id="google_analytics" name="google_analytics" 
                                       value="<?php echo esc_attr($settings['google_analytics'] ?? ''); ?>" 
                                       class="regular-text" placeholder="G-XXXXXXXXXX">
                                <p class="description"><?php _e('מזהה Google Analytics לאנליטיקה מתקדמת', 'leadgrid'); ?></p>
                            </td>
                        </tr>
                        
                        <tr>
                            <th scope="row">
                                <label for="facebook_pixel"><?php _e('Facebook Pixel ID', 'leadgrid'); ?></label>
                            </th>
                            <td>
                                <input type="text" id="facebook_pixel" name="facebook_pixel" 
                                       value="<?php echo esc_attr($settings['facebook_pixel'] ?? ''); ?>" 
                                       class="regular-text" placeholder="123456789">
                                <p class="description"><?php _e('מזהה Facebook Pixel למעקב אחר המרות', 'leadgrid'); ?></p>
                            </td>
                        </tr>
                        
                        <tr>
                            <th scope="row">
                                <label for="default_from_email"><?php _e('כתובת מייל ברירת מחדל', 'leadgrid'); ?></label>
                            </th>
                            <td>
                                <input type="email" id="default_from_email" name="default_from_email" 
                                       value="<?php echo esc_attr($settings['default_from_email'] ?? get_option('admin_email')); ?>" 
                                       class="regular-text">
                                <p class="description"><?php _e('כתובת המייל ממנה יישלחו הודעות מטפסי יצירת הקשר', 'leadgrid'); ?></p>
                            </td>
                        </tr>
                        
                        <tr>
                            <th scope="row">
                                <label for="smtp_host"><?php _e('שרת SMTP', 'leadgrid'); ?></label>
                            </th>
                            <td>
                                <input type="text" id="smtp_host" name="smtp_host" 
                                       value="<?php echo esc_attr($settings['smtp_host'] ?? ''); ?>" 
                                       class="regular-text" placeholder="smtp.gmail.com">
                                <p class="description"><?php _e('שרת SMTP לשליחת מיילים (אופציונלי)', 'leadgrid'); ?></p>
                            </td>
                        </tr>
                        
                        <tr>
                            <th scope="row">
                                <label for="enable_caching"><?php _e('הפעל מטמון', 'leadgrid'); ?></label>
                            </th>
                            <td>
                                <input type="checkbox" id="enable_caching" name="enable_caching" value="1" 
                                       <?php checked($settings['enable_caching'] ?? true); ?>>
                                <p class="description"><?php _e('מטמון משפר את מהירות הטעינה של הדפים', 'leadgrid'); ?></p>
                            </td>
                        </tr>
                        
                        <tr>
                            <th scope="row">
                                <label for="enable_ssl"><?php _e('אכוף HTTPS', 'leadgrid'); ?></label>
                            </th>
                            <td>
                                <input type="checkbox" id="enable_ssl" name="enable_ssl" value="1" 
                                       <?php checked($settings['enable_ssl'] ?? true); ?>>
                                <p class="description"><?php _e('הפניית כל התעבורה ל-HTTPS לאבטחה מירבית', 'leadgrid'); ?></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <?php submit_button(__('שמור הגדרות', 'leadgrid')); ?>
            </form>
        </div>
        <?php
    }
    
    /**
     * Save settings
     */
    private function save_settings() {
        if (!wp_verify_nonce($_POST['_wpnonce'], 'leadgrid_settings')) {
            return;
        }
        
        $settings = array(
            'google_analytics' => sanitize_text_field($_POST['google_analytics'] ?? ''),
            'facebook_pixel' => sanitize_text_field($_POST['facebook_pixel'] ?? ''),
            'default_from_email' => sanitize_email($_POST['default_from_email'] ?? ''),
            'smtp_host' => sanitize_text_field($_POST['smtp_host'] ?? ''),
            'enable_caching' => isset($_POST['enable_caching']),
            'enable_ssl' => isset($_POST['enable_ssl'])
        );
        
        update_option('leadgrid_settings', $settings);
        
        echo '<div class="notice notice-success"><p>' . __('הגדרות נשמרו בהצלחה!', 'leadgrid') . '</p></div>';
    }
    
    /**
     * Render pages table
     */
    private function render_pages_table() {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        $pages = $wpdb->get_results("SELECT * FROM $table_name ORDER BY created_at DESC");
        
        if (empty($pages)) {
            echo '<tr><td colspan="6" style="text-align: center; padding: 40px;">';
            echo '<div style="color: #666;">';
            echo '<h3>' . __('עדיין לא יצרת דפים', 'leadgrid') . '</h3>';
            echo '<p>' . __('התחל ליצור את הדף הראשון שלך עכשיו!', 'leadgrid') . '</p>';
            echo '<a href="' . admin_url('admin.php?page=leadgrid-new') . '" class="button button-primary">' . __('צור דף חדש', 'leadgrid') . '</a>';
            echo '</div>';
            echo '</td></tr>';
            return;
        }
        
        foreach ($pages as $page) {
            $page_url = home_url('/leadgrid/' . $page->slug);
            $status_class = 'status-' . $page->status;
            $status_text = $page->status === 'published' ? __('פורסם', 'leadgrid') : __('טיוטה', 'leadgrid');
            
            echo '<tr>';
            echo '<th scope="row" class="check-column"><input type="checkbox" name="page[]" value="' . $page->id . '"></th>';
            echo '<td class="title column-title"><strong>' . esc_html($page->title) . '</strong></td>';
            echo '<td class="column-slug"><a href="' . esc_url($page_url) . '" target="_blank" class="page-url">' . esc_html($page->slug) . '</a></td>';
            echo '<td class="column-status"><span class="' . $status_class . '">' . $status_text . '</span></td>';
            echo '<td class="column-date">' . date_i18n(get_option('date_format'), strtotime($page->created_at)) . '</td>';
            echo '<td class="column-actions">';
            echo '<div class="page-actions">';
            echo '<a href="' . esc_url($page_url) . '" target="_blank" class="button button-small">' . __('צפה', 'leadgrid') . '</a>';
            echo '<a href="#" class="button button-small edit-page" data-id="' . $page->id . '">' . __('ערוך', 'leadgrid') . '</a>';
            echo '<a href="#" class="button button-small duplicate-page" data-id="' . $page->id . '">' . __('שכפל', 'leadgrid') . '</a>';
            echo '<a href="#" class="button button-small delete-page" data-id="' . $page->id . '" style="color: #dc3545;">' . __('מחק', 'leadgrid') . '</a>';
            echo '</div>';
            echo '</td>';
            echo '</tr>';
        }
    }
    
    /**
     * Get pages count
     */
    private function get_pages_count() {
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        return $wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE status = 'published'");
    }
    
    /**
     * Get views count (placeholder)
     */
    private function get_views_count() {
        return rand(1000, 9999); // Placeholder - implement actual analytics
    }
    
    /**
     * AJAX save page
     */
    public function ajax_save_page() {
        check_ajax_referer('leadgrid_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die(__('אין לך הרשאות מספיקות', 'leadgrid'));
        }
        
        $page_data = json_decode(stripslashes($_POST['page_data']), true);
        
        if (empty($page_data)) {
            wp_send_json_error(__('נתוני הדף חסרים', 'leadgrid'));
            return;
        }
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        
        // Generate slug from title
        $slug = sanitize_title($page_data['title']);
        $original_slug = $slug;
        $counter = 1;
        
        // Make sure slug is unique
        while ($wpdb->get_var($wpdb->prepare("SELECT id FROM $table_name WHERE slug = %s", $slug))) {
            $slug = $original_slug . '-' . $counter;
            $counter++;
        }
        
        // Generate HTML content
        $html_content = $this->generate_page_html($page_data);
        
        $result = $wpdb->insert(
            $table_name,
            array(
                'title' => sanitize_text_field($page_data['title']),
                'slug' => $slug,
                'content' => $html_content,
                'template_data' => json_encode($page_data),
                'status' => 'published',
                'author_id' => get_current_user_id(),
                'meta_title' => sanitize_text_field($page_data['meta_title'] ?? $page_data['title']),
                'meta_description' => sanitize_textarea_field($page_data['meta_description'] ?? ''),
                'custom_css' => wp_strip_all_tags($page_data['custom_css'] ?? ''),
                'custom_js' => wp_strip_all_tags($page_data['custom_js'] ?? '')
            ),
            array('%s', '%s', '%s', '%s', '%s', '%d', '%s', '%s', '%s', '%s')
        );
        
        if ($result === false) {
            wp_send_json_error(__('שגיאה בשמירת הדף במסד הנתונים', 'leadgrid'));
            return;
        }
        
        wp_send_json_success(array(
            'message' => __('הדף נשמר בהצלחה!', 'leadgrid'),
            'page_id' => $wpdb->insert_id,
            'page_url' => home_url('/leadgrid/' . $slug)
        ));
    }
    
    /**
     * Generate page HTML
     */
    private function generate_page_html($page_data) {
        ob_start();
        ?>
        <!DOCTYPE html>
        <html lang="he" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title><?php echo esc_html($page_data['meta_title'] ?? $page_data['title']); ?></title>
            <meta name="description" content="<?php echo esc_attr($page_data['meta_description'] ?? ''); ?>">
            
            <!-- Tailwind CSS -->
            <script src="https://cdn.tailwindcss.com"></script>
            
            <!-- Custom CSS -->
            <?php if (!empty($page_data['custom_css'])): ?>
            <style>
                <?php echo wp_strip_all_tags($page_data['custom_css']); ?>
            </style>
            <?php endif; ?>
            
            <!-- Analytics -->
            <?php $settings = get_option('leadgrid_settings', array()); ?>
            <?php if (!empty($settings['google_analytics'])): ?>
            <script async src="https://www.googletagmanager.com/gtag/js?id=<?php echo esc_attr($settings['google_analytics']); ?>"></script>
            <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', '<?php echo esc_attr($settings['google_analytics']); ?>');
            </script>
            <?php endif; ?>
            
            <?php if (!empty($settings['facebook_pixel'])): ?>
            <script>
                !function(f,b,e,v,n,t,s)
                {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                n.queue=[];t=b.createElement(e);t.async=!0;
                t.src=v;s=b.getElementsByTagName(e)[0];
                s.parentNode.insertBefore(t,s)}(window,document,'script',
                'https://connect.facebook.net/en_US/fbevents.js');
                fbq('init', '<?php echo esc_attr($settings['facebook_pixel']); ?>');
                fbq('track', 'PageView');
            </script>
            <noscript>
                <img height="1" width="1" style="display:none"
                     src="https://www.facebook.com/tr?id=<?php echo esc_attr($settings['facebook_pixel']); ?>&ev=PageView&noscript=1"/>
            </noscript>
            <?php endif; ?>
        </head>
        <body class="font-sans antialiased">
            
            <?php
            // Generate sections based on template data
            $this->render_hero_section($page_data);
            $this->render_features_section($page_data);
            $this->render_testimonials_section($page_data);
            $this->render_contact_section($page_data);
            ?>
            
            <!-- Custom JavaScript -->
            <?php if (!empty($page_data['custom_js'])): ?>
            <script>
                <?php echo wp_strip_all_tags($page_data['custom_js']); ?>
            </script>
            <?php endif; ?>
            
            <!-- Contact Form Handler -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const contactForms = document.querySelectorAll('.leadgrid-contact-form');
                contactForms.forEach(form => {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const formData = new FormData(form);
                        formData.append('action', 'leadgrid_submit_contact');
                        formData.append('page_id', '<?php echo esc_js($page_data['id'] ?? ''); ?>');
                        
                        fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('ההודעה נשלחה בהצלחה!');
                                form.reset();
                            } else {
                                alert('אירעה שגיאה בשליחת ההודעה');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('אירעה שגיאה בשליחת ההודעה');
                        });
                    });
                });
            });
            </script>
        </body>
        </html>
        <?php
        return ob_get_clean();
    }
    
    /**
     * Render hero section
     */
    private function render_hero_section($page_data) {
        $hero = $page_data['hero'] ?? array();
        if (empty($hero)) return;
        
        $bg_color = $page_data['styles']['heroBackground'] ?? '#1e40af';
        $text_color = $page_data['styles']['textColor'] ?? '#ffffff';
        ?>
        <section class="relative py-20 px-4 text-center" style="background-color: <?php echo esc_attr($bg_color); ?>; color: <?php echo esc_attr($text_color); ?>;">
            <div class="max-w-4xl mx-auto">
                <?php if (!empty($hero['title'])): ?>
                <h1 class="text-4xl md:text-6xl font-bold mb-6">
                    <?php echo esc_html($hero['title']); ?>
                </h1>
                <?php endif; ?>
                
                <?php if (!empty($hero['subtitle'])): ?>
                <h2 class="text-xl md:text-2xl mb-6 opacity-90">
                    <?php echo esc_html($hero['subtitle']); ?>
                </h2>
                <?php endif; ?>
                
                <?php if (!empty($hero['description'])): ?>
                <p class="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto">
                    <?php echo esc_html($hero['description']); ?>
                </p>
                <?php endif; ?>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <?php if (!empty($hero['button1Text'])): ?>
                    <button class="bg-white text-black px-8 py-3 text-lg font-bold rounded-lg hover:bg-opacity-90 transition-all">
                        <?php echo esc_html($hero['button1Text']); ?>
                    </button>
                    <?php endif; ?>
                    
                    <?php if (!empty($hero['button2Text'])): ?>
                    <button class="border-2 border-white bg-transparent px-8 py-3 text-lg font-bold rounded-lg hover:bg-white hover:text-black transition-all">
                        <?php echo esc_html($hero['button2Text']); ?>
                    </button>
                    <?php endif; ?>
                </div>
            </div>
        </section>
        <?php
    }
    
    /**
     * Render features section
     */
    private function render_features_section($page_data) {
        $features = $page_data['features'] ?? array();
        if (empty($features['items'])) return;
        
        $bg_color = $page_data['styles']['featuresBackground'] ?? '#f8fafc';
        $text_color = $page_data['styles']['textColor'] ?? '#000000';
        $primary_color = $page_data['styles']['primaryColor'] ?? '#1e40af';
        ?>
        <section class="py-20 px-4" style="background-color: <?php echo esc_attr($bg_color); ?>; color: <?php echo esc_attr($text_color); ?>;">
            <div class="max-w-6xl mx-auto">
                <?php if (!empty($features['title'])): ?>
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-4" style="color: <?php echo esc_attr($primary_color); ?>;">
                    <?php echo esc_html($features['title']); ?>
                </h2>
                <?php endif; ?>
                
                <?php if (!empty($features['subtitle'])): ?>
                <p class="text-lg text-center mb-12 opacity-80">
                    <?php echo esc_html($features['subtitle']); ?>
                </p>
                <?php endif; ?>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <?php foreach ($features['items'] as $item): ?>
                    <div class="bg-white p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition-shadow">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" 
                             style="background-color: <?php echo esc_attr($primary_color); ?>20;">
                            <span class="text-2xl"><?php echo $this->get_icon($item['icon'] ?? 'star'); ?></span>
                        </div>
                        <h3 class="text-xl font-bold mb-3" style="color: <?php echo esc_attr($primary_color); ?>;">
                            <?php echo esc_html($item['title']); ?>
                        </h3>
                        <p class="opacity-80">
                            <?php echo esc_html($item['description']); ?>
                        </p>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </section>
        <?php
    }
    
    /**
     * Render testimonials section
     */
    private function render_testimonials_section($page_data) {
        $testimonials = $page_data['testimonials'] ?? array();
        if (empty($testimonials['testimonials'])) return;
        
        $bg_color = $page_data['styles']['testimonialsBackground'] ?? '#ffffff';
        $text_color = $page_data['styles']['textColor'] ?? '#000000';
        $primary_color = $page_data['styles']['primaryColor'] ?? '#1e40af';
        ?>
        <section class="py-20 px-4" style="background-color: <?php echo esc_attr($bg_color); ?>; color: <?php echo esc_attr($text_color); ?>;">
            <div class="max-w-6xl mx-auto">
                <?php if (!empty($testimonials['title'])): ?>
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12" style="color: <?php echo esc_attr($primary_color); ?>;">
                    <?php echo esc_html($testimonials['title']); ?>
                </h2>
                <?php endif; ?>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <?php foreach ($testimonials['testimonials'] as $testimonial): ?>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-lg">
                        <div class="flex mb-4">
                            <?php for ($i = 0; $i < ($testimonial['rating'] ?? 5); $i++): ?>
                            <span class="text-yellow-400">★</span>
                            <?php endfor; ?>
                        </div>
                        <p class="mb-4 italic">
                            "<?php echo esc_html($testimonial['content']); ?>"
                        </p>
                        <div class="flex items-center">
                            <?php if (!empty($testimonial['image'])): ?>
                            <img src="<?php echo esc_url($testimonial['image']); ?>" 
                                 alt="<?php echo esc_attr($testimonial['name']); ?>" 
                                 class="w-12 h-12 rounded-full ml-4">
                            <?php endif; ?>
                            <div>
                                <h4 class="font-bold"><?php echo esc_html($testimonial['name']); ?></h4>
                                <p class="text-sm opacity-70"><?php echo esc_html($testimonial['role']); ?></p>
                            </div>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </section>
        <?php
    }
    
    /**
     * Render contact section
     */
    private function render_contact_section($page_data) {
        $contact = $page_data['contact'] ?? array();
        if (empty($contact)) return;
        
        $bg_color = $page_data['styles']['contactBackground'] ?? '#f1f5f9';
        $text_color = $page_data['styles']['textColor'] ?? '#000000';
        $primary_color = $page_data['styles']['primaryColor'] ?? '#1e40af';
        ?>
        <section class="py-20 px-4" style="background-color: <?php echo esc_attr($bg_color); ?>; color: <?php echo esc_attr($text_color); ?>;">
            <div class="max-w-4xl mx-auto text-center">
                <?php if (!empty($contact['title'])): ?>
                <h2 class="text-3xl md:text-4xl font-bold mb-6" style="color: <?php echo esc_attr($primary_color); ?>;">
                    <?php echo esc_html($contact['title']); ?>
                </h2>
                <?php endif; ?>
                
                <?php if (!empty($contact['subtitle'])): ?>
                <p class="text-lg mb-12 opacity-80">
                    <?php echo esc_html($contact['subtitle']); ?>
                </p>
                <?php endif; ?>
                
                <div class="bg-white p-8 rounded-lg shadow-lg max-w-2xl mx-auto">
                    <form class="leadgrid-contact-form space-y-4">
                        <input type="text" name="name" placeholder="השם שלכם" required
                               class="w-full p-4 border border-gray-300 rounded-lg">
                        <input type="email" name="email" placeholder="כתובת מייל" required
                               class="w-full p-4 border border-gray-300 rounded-lg">
                        <input type="tel" name="phone" placeholder="מספר טלפון"
                               class="w-full p-4 border border-gray-300 rounded-lg">
                        <textarea name="message" placeholder="איך נוכל לעזור לכם?" rows="4" required
                                  class="w-full p-4 border border-gray-300 rounded-lg"></textarea>
                        
                        <button type="submit" class="w-full py-4 text-lg text-white font-bold rounded-lg hover:opacity-90 transition-all"
                                style="background-color: <?php echo esc_attr($primary_color); ?>;">
                            <?php echo esc_html($contact['buttonText'] ?? 'שלחו הודעה'); ?>
                        </button>
                    </form>
                </div>
            </div>
        </section>
        <?php
    }
    
    /**
     * Get icon for feature
     */
    private function get_icon($icon_name) {
        $icons = array(
            'star' => '⭐',
            'heart' => '❤️',
            'zap' => '⚡',
            'shield' => '🛡️',
            'award' => '🏆',
            'target' => '🎯'
        );
        
        return $icons[$icon_name] ?? '⭐';
    }
    
    /**
     * Handle LeadGrid page display
     */
    public function handle_leadgrid_page_display() {
        if (!isset($_GET['leadgrid_page'])) {
            return;
        }
        
        $slug = sanitize_text_field($_GET['leadgrid_page']);
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        $page = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE slug = %s AND status = 'published'", $slug));
        
        if (!$page) {
            wp_die(__('הדף לא נמצא', 'leadgrid'), 404);
        }
        
        // Output the page content
        echo $page->content;
        exit;
    }
    
    /**
     * LeadGrid page shortcode
     */
    public function leadgrid_page_shortcode($atts) {
        $atts = shortcode_atts(array(
            'slug' => ''
        ), $atts);
        
        if (empty($atts['slug'])) {
            return __('חסר פרמטר slug', 'leadgrid');
        }
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        $page = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE slug = %s AND status = 'published'", $atts['slug']));
        
        if (!$page) {
            return __('הדף לא נמצא', 'leadgrid');
        }
        
        return $page->content;
    }
    
    /**
     * AJAX get pages
     */
    public function ajax_get_pages() {
        check_ajax_referer('leadgrid_nonce', 'nonce');
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        $pages = $wpdb->get_results("SELECT * FROM $table_name ORDER BY created_at DESC");
        
        wp_send_json_success($pages);
    }
    
    /**
     * AJAX delete page
     */
    public function ajax_delete_page() {
        check_ajax_referer('leadgrid_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(__('אין לך הרשאות מספיקות', 'leadgrid'));
        }
        
        $page_id = intval($_POST['page_id']);
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        $result = $wpdb->delete($table_name, array('id' => $page_id), array('%d'));
        
        if ($result === false) {
            wp_send_json_error(__('שגיאה במחיקת הדף', 'leadgrid'));
        }
        
        wp_send_json_success(__('הדף נמחק בהצלחה', 'leadgrid'));
    }
    
    /**
     * AJAX duplicate page
     */
    public function ajax_duplicate_page() {
        check_ajax_referer('leadgrid_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(__('אין לך הרשאות מספיקות', 'leadgrid'));
        }
        
        $page_id = intval($_POST['page_id']);
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'leadgrid_pages';
        $original = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE id = %d", $page_id));
        
        if (!$original) {
            wp_send_json_error(__('הדף המקורי לא נמצא', 'leadgrid'));
        }
        
        // Generate new slug
        $new_slug = $original->slug . '-copy';
        $counter = 1;
        while ($wpdb->get_var($wpdb->prepare("SELECT id FROM $table_name WHERE slug = %s", $new_slug))) {
            $new_slug = $original->slug . '-copy-' . $counter;
            $counter++;
        }
        
        $result = $wpdb->insert(
            $table_name,
            array(
                'title' => $original->title . ' (עותק)',
                'slug' => $new_slug,
                'content' => $original->content,
                'template_data' => $original->template_data,
                'status' => 'draft',
                'author_id' => get_current_user_id(),
                'meta_title' => $original->meta_title,
                'meta_description' => $original->meta_description,
                'custom_css' => $original->custom_css,
                'custom_js' => $original->custom_js
            ),
            array('%s', '%s', '%s', '%s', '%s', '%d', '%s', '%s', '%s', '%s')
        );
        
        if ($result === false) {
            wp_send_json_error(__('שגיאה בשכפול הדף', 'leadgrid'));
        }
        
        wp_send_json_success(__('הדף שוכפל בהצלחה', 'leadgrid'));
    }
}

// Initialize the plugin
LeadGridPlugin::get_instance();

// Add rewrite rules for custom URLs
add_action('init', function() {
    add_rewrite_rule('^leadgrid/([^/]+)/?$', 'index.php?leadgrid_page=$matches[1]', 'top');
});

add_filter('query_vars', function($vars) {
    $vars[] = 'leadgrid_page';
    return $vars;
});

// Handle contact form submissions
add_action('wp_ajax_leadgrid_submit_contact', 'leadgrid_handle_contact_form');
add_action('wp_ajax_nopriv_leadgrid_submit_contact', 'leadgrid_handle_contact_form');

function leadgrid_handle_contact_form() {
    $name = sanitize_text_field($_POST['name'] ?? '');
    $email = sanitize_email($_POST['email'] ?? '');
    $phone = sanitize_text_field($_POST['phone'] ?? '');
    $message = sanitize_textarea_field($_POST['message'] ?? '');
    $page_id = intval($_POST['page_id'] ?? 0);
    
    if (empty($name) || empty($email) || empty($message)) {
        wp_send_json_error(__('נא למלא את כל השדות החובה', 'leadgrid'));
        return;
    }
    
    // Get settings
    $settings = get_option('leadgrid_settings', array());
    $to_email = $settings['default_from_email'] ?? get_option('admin_email');
    
    // Prepare email
    $subject = sprintf(__('הודעה חדשה מדף LeadGrid - %s', 'leadgrid'), $name);
    $email_message = sprintf(
        __("הודעה חדשה התקבלה מדף LeadGrid:\n\nשם: %s\nמייל: %s\nטלפון: %s\n\nהודעה:\n%s", 'leadgrid'),
        $name,
        $email,
        $phone,
        $message
    );
    
    $headers = array(
        'Content-Type: text/plain; charset=UTF-8',
        'From: ' . $name . ' <' . $email . '>',
        'Reply-To: ' . $email
    );
    
    // Send email
    $sent = wp_mail($to_email, $subject, $email_message, $headers);
    
    if ($sent) {
        wp_send_json_success(__('ההודעה נשלחה בהצלחה!', 'leadgrid'));
    } else {
        wp_send_json_error(__('אירעה שגיאה בשליחת ההודעה', 'leadgrid'));
    }
}

// Add admin scripts and styles
add_action('admin_footer', function() {
    if (isset($_GET['page']) && strpos($_GET['page'], 'leadgrid') !== false) {
        ?>
        <script>
        jQuery(document).ready(function($) {
            // Delete page
            $('.delete-page').on('click', function(e) {
                e.preventDefault();
                
                if (!confirm(leadgrid_ajax.strings.confirm_delete)) {
                    return;
                }
                
                const pageId = $(this).data('id');
                const row = $(this).closest('tr');
                
                $.post(leadgrid_ajax.ajax_url, {
                    action: 'leadgrid_delete_page',
                    page_id: pageId,
                    nonce: leadgrid_ajax.nonce
                }, function(response) {
                    if (response.success) {
                        row.fadeOut(function() {
                            row.remove();
                        });
                    } else {
                        alert(response.data);
                    }
                });
            });
            
            // Duplicate page
            $('.duplicate-page').on('click', function(e) {
                e.preventDefault();
                
                const pageId = $(this).data('id');
                
                $.post(leadgrid_ajax.ajax_url, {
                    action: 'leadgrid_duplicate_page',
                    page_id: pageId,
                    nonce: leadgrid_ajax.nonce
                }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.data);
                    }
                });
            });
            
            // Edit page - open in new editor
            $('.edit-page').on('click', function(e) {
                e.preventDefault();
                const pageId = $(this).data('id');
                window.location.href = '<?php echo admin_url("admin.php?page=leadgrid-new&edit="); ?>' + pageId;
            });
            
            // Search functionality
            $('#leadgrid-search').on('keyup', function() {
                const value = $(this).val().toLowerCase();
                $('#leadgrid-pages-tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });
        });
        </script>
        <?php
    }
});
?>
